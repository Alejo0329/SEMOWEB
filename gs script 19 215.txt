// --- CONFIGURACIÓN PROYECTO SEMO ---
const SHEET_NAME = "Ventas";
const PDF_LINK = "https://drive.google.com/file/d/1ILLCGt0WBd9JtSbsv_W36YbdocZj879o/view?usp=drivesdk";
const STATUS_TRIGGER = "CONFIRMADO";

/**
 * 1. MANEJO DE PETICIONES GET (Para el Contador)
 */
function doGet(e) {
  const action = e ? e.parameter.action : "checkStatus";
  
  if (action === "checkStatus") {
    const result = getStatus();
    return ContentService.createTextOutput(JSON.stringify(result))
      .setMimeType(ContentService.MimeType.JSON);
  }
  
  return ContentService.createTextOutput("SEMO Backend Online");
}

/**
 * 2. MANEJO DE PETICIONES POST (Para el Registro)
 */
function doPost(e) {
  const lock = LockService.getScriptLock();
  lock.tryLock(10000); 

  try {
    const params = JSON.parse(e.postData.contents);
    const action = params.action;
    let result = {};

    if (action === "checkStatus") {
      result = getStatus();
    } else if (action === "registerSale") {
      result = registerSale(params);
    } else {
      result = { status: "error", message: "Acción desconocida" };
    }

    return ContentService.createTextOutput(JSON.stringify(result))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({ status: "error", message: error.toString() }))
      .setMimeType(ContentService.MimeType.JSON);
  } finally {
    lock.releaseLock();
  }
}

// 3. CORS HELPER
function doOptions(e) {
  return ContentService.createTextOutput("");
}

/**
 * LÓGICA DE CONTADOR
 * Lee la hoja y suma la Columna E (Cantidad) solo si Columna F (Estado) es "CONFIRMADO".
 */
function getStatus() {
  const sheet = getSheet();
  const data = sheet.getDataRange().getValues();
  let totalSold = 0;
  
  if (data.length > 1) {
    for (let i = 1; i < data.length; i++) {
        const row = data[i];
        // Columna E (Índice 4) -> Cantidad
        // Columna F (Índice 5) -> Estado
        const qty = parseInt(row[4]); 
        const status = (row[5] || "").toString().toUpperCase(); 

        if (!isNaN(qty) && (status === STATUS_TRIGGER || status === "ENVIADO")) {
            totalSold += qty;
        }
    }
  }
  return { result: "success", sold: totalSold };
}

/**
 * LÓGICA DE REGISTRO
 * Escribe en el orden histórico:
 * A: Fecha, B: Nombre, C: Correo, D: Referido, E: Cantidad, F: Estado, G: Método, H: TxID, I: PDF Link
 */
function registerSale(data) {
  const sheet = getSheet();
  
  sheet.appendRow([
    new Date(),           // A: Fecha
    data.nombre,          // B: Nombre
    data.correo,          // C: Correo
    data.referido || "",  // D: Referido
    data.cantidad,        // E: Cantidad
    "PENDIENTE",          // F: Estado (Trigger se activa cuando cambies esto a CONFIRMADO)
    data.metodo,          // G: Método
    data.txHash || "",    // H: Hash
    PDF_LINK,             // I: Link PDF (Automático)
    ""                    // J: Email Status (Vacío)
  ]);

  return { status: "success", message: "Venta registrada" };
}

// Helper Sheet
function getSheet() {
  const ss = SpreadsheetApp.getActive();
  if (!ss) throw new Error("Script no vinculado.");
  
  let sheet = ss.getSheetByName(SHEET_NAME);
  if (!sheet) { // Si no existe, la crea con encabezados correctos
    sheet = ss.insertSheet(SHEET_NAME);
    sheet.appendRow(["Fecha", "Nombre", "Correo", "Referido", "Cantidad", "Estado", "Método", "Hash", "Link PDF", "Email Status"]);
  }
  return sheet;
}

/**
 * 4. DISPARADOR AUTOMÁTICO (TRIGGER)
 * Vigila la Columna F (6). Si cambia a CONFIRMADO, envía el correo.
 */
function checkAndSendEmail_Trigger(e) {
  if (!e) return;
  
  const sheet = e.range.getSheet();
  if (sheet.getName() !== SHEET_NAME) return;

  const row = e.range.getRow();
  const col = e.range.getColumn();
  const value = (e.value || e.range.getValue()).toString().toUpperCase();

  // Si editamos la Columna 6 (F) y pusimos "CONFIRMADO"
  if (col === 6 && value === STATUS_TRIGGER) {
    
    // Leer datos de la fila
    const name = sheet.getRange(row, 2).getValue();   // Col B Name
    const email = sheet.getRange(row, 3).getValue();  // Col C Email
    const pdfUrl = sheet.getRange(row, 9).getValue(); // Col I PDF Link
    const statusCell = sheet.getRange(row, 10);       // Col J Status Email

    if (statusCell.getValue() === "Enviado") return; // Evitar duplicados

    if (email && pdfUrl) {
      try {
        sendPdfEmail(name, email, pdfUrl);
        statusCell.setValue("Enviado");
      } catch (err) {
        statusCell.setValue("Error: " + err.message);
      }
    } else {
      statusCell.setValue("Faltan datos");
    }
  }
}

/**
 * 5. PLANTILLA DE CORREO "HOMO LUDENS" (MODO JUEGO)
 */
function sendPdfEmail(name, email, link) {
  const subject = "?? ¡Misión Cumplida! Has desbloqueado el Nivel 5 en SEMO";
  
  const htmlBody = `
    <div style="font-family: 'Verdana', sans-serif; color: #1a1a1a; max-width: 600px; margin: 0 auto; border: 2px solid #2E86C1; border-radius: 10px; overflow: hidden;">
      
      <div style="background-color: #2E86C1; padding: 20px; text-align: center;">
        <h1 style="color: #ffffff; margin: 0;">¡BIENVENIDO, JUGADOR!</h1>
      </div>

      <div style="padding: 30px;">
        <h2 style="color: #2E86C1;">Hola, ${name} (Avatar: Investor) ??</h2>
        
        <p>¡Enhorabuena! Has completado con éxito la misión <strong>"Semilla del Legado"</strong>.</p>
        
        <p>Tu aporte ha sido validado en la Blockchain y has desbloqueado los siguientes beneficios:</p>
        
        <ul style="background-color: #f0f8ff; padding: 15px 30px; border-radius: 5px;">
          <li>??? <strong>Item Obtenido:</strong> Certificado de Propiedad Digital (NFT/Respaldo).</li>
          <li>?? <strong>XP Ganada:</strong> Acceso al Curso de Finanzas Cuánticas.</li>
          <li>?? <strong>Rango Actual:</strong> Pionero (Early Adopter).</li>
        </ul>

        <p style="text-align: center; margin: 30px 0;">
          <span style="font-size: 14px; color: #555;">Haz clic abajo para equipar tu item:</span><br><br>
          <a href="${link}" style="background-color: #28B463; color: white; padding: 15px 25px; text-decoration: none; border-radius: 50px; font-weight: bold; font-size: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            ?? DESCARGAR MI CERTIFICADO
          </a>
        </p>

        <p><strong>Tu próxima misión:</strong> Ingresa a la plataforma y activa el "Modo Espejo" para ver crecer tu inversión en tiempo real.</p>
        
        <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">
        <p style="font-size: 12px; color: #777; text-align: center;">
          <em>"El juego de la vida premia a los que se atreven a jugar." - Huizinga</em><br>
          Ecosistema SEMO | Soporte al Jugador
        </p>
      </div>
    </div>
  `;
  
  GmailApp.sendEmail(email, subject, "", {
    htmlBody: htmlBody,
    name: "SEMO System"
  });
}

// SETUP TRIGGER (Ejecutar una vez manualmente si no está configurado)
function setupTrigger() {
  const triggers = ScriptApp.getProjectTriggers();
  for (let i = 0; i < triggers.length; i++) {
    if (triggers[i].getHandlerFunction() === "checkAndSendEmail_Trigger") return;
  }
  ScriptApp.newTrigger("checkAndSendEmail_Trigger")
    .forSpreadsheet(SpreadsheetApp.getActive())
    .onEdit()
    .create();
}
